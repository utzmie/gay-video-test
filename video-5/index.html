<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ホモ5</title>
	<meta property="og:title" content="ホモ5">
	<meta property="og:type" content="article">
	<meta property="og:image" content="https://utzmie.github.io/gay-video-test/video-5/ogp.jpg">
	<meta property="og:url" content="https://utzmie.github.io/gay-video-test/video-5/">
	<meta property="og:description" content="HTML5(canvas)でクロマキー合成テスト">
	<meta property="og:site_name" content="ホモ5">
	<meta property="og:locale" content="ja_JP">
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="ホモ5">
	<meta name="twitter:description" content="HTML5(canvas)でクロマキー合成テスト">
	<meta name="twitter:image" content="https://utzmie.github.io/gay-video-test/video-5/ogp.jpg">
	<link rel="stylesheet" href="../style.css">
</head>
<body>

	<div class="container">
		<h1>HTML5(canvas)でクロマキー合成テスト</h1>

		<div style="display: none;">
		<h2>video</h2>
		<video id="gay" muted autoplay loop controls width="480" height="270">
			<source src="../gay.mp4">
		</video>
		</div>

		<h2>canvas</h2>
		<div class="canvas-container video-4">
			<canvas id="canvas" width="480" height="270"></canvas>
			<div class="canvas-bg-container">
				<div class="canvas-bg canvas-bg1" id="canvas-bg">
					<!-- <img style="display: none;" src="./bg.jpg" alt=""> -->
				</div>
			</div>
		</div>

		<p>背景を好きな画像に変更してみよう</p>
		<p class="input-container">
			<input type="file" id="image_url" name="image_url">
			<button class="button" type="submit" id="image_submit" name="image_submit">変更</button>
		</p>
		<style>
			.input-container {
				display: -webkit-flex;
				display: -moz-flex;
				display: -ms-flex;
				display: flex;
				align-items: flex-start;
			}
			.input-container input[type="file"] {
				width: 100%;
				border: 3px solid #ddd;
				padding: 1.25em 1em;
				cursor: pointer;
				box-sizing: border-box;
				margin-right: 1em;
				font-size: 12px;
			}
			.input-container input[type="file"]:hover {
				border-color: #E8A1A8;
			}
			.input-container button {
				width: auto;
				margin: 0;	
			}
		</style>

		<p class="pagination"><a href="../video-4/">前へ</a></p>

		<p><a href="../">HOMO</a></p>
	</div><!-- /container -->

	<script>
		var video  = document.getElementById('gay');
		var canvas = document.getElementById('canvas');
		var context = canvas.getContext("2d");

		window.onload = function() {
			draw();	
		}

		// 参考： http://qiita.com/keiskimu/items/a4fc9ebb338906b9813e
		var draw = function() {
			context.drawImage(video, 0, 0, canvas.width, canvas.height);
			chromaKey();
			requestAnimationFrame(draw)
		}

		// background color
		var chromaKeyColor = {
			r: 0,
			g: 0,
			b: 255
		};

        var colorDistance = 30;

		var chromaKey = function () {
			var imageData = context.getImageData(0, 0, canvas.width, canvas.height);
			var data = imageData.data;

			for (var i = 0, l = data.length; i < l; i += 4) {

				var target = {
					r: data[i],
					g: data[i + 1],
					b: data[i + 2]
				};

				if (getColorDistance(chromaKeyColor, target) < colorDistance) {
						data[i + 3] = 0;
					}
				}

			imageData.data = data;
			context.putImageData(imageData, 0, 0);
		};

		var getColorDistance = function (rgb1, rgb2) {
			return Math.sqrt(
				Math.pow((rgb1.r - rgb2.r), 2) +
				Math.pow((rgb1.g - rgb2.g), 2) +
				Math.pow((rgb1.b - rgb2.b), 2)
			);
		};



		// 背景画像の変更
		var up_file      = document.getElementById('image_url');
		var image_submit = document.getElementById('image_submit');
		var canvas_bg    = document.getElementById('canvas-bg');

		image_submit.addEventListener('click', function(e) {
			
			var image_data = up_file.files[0];

			fileReader = new FileReader();
			fileReader.readAsDataURL(image_data);

			fileReader.onload = function(event) {
				var image_data_uri = event.target.result;				
				canvas_bg.setAttribute('style',
					'background-image: url("' + image_data_uri + '");'
				);
			};

		});

	</script>
</body>
</html>